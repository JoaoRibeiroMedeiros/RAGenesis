AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation Template to Deploy EC2 with Milvus

Parameters:
  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: 'c5n.xlarge'
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - c5n.xlarge
    ConstraintDescription: Must be a valid EC2 instance type.

  KeyName:
    Default: MilvusKeyPair
    Description: Name of an existing EC2 KeyPair to enable SSH access.
    Type: AWS::EC2::KeyPair::KeyName

Resources:
  MilvusInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: ami-0427090fd1714168b  # Replace with the latest Ubuntu AMI in your region
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !Ref MilvusSecurityGroup

      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash
              set -e
              # exec > /var/log/user-data.log 2>&1
              
              # echo "Updating package index..."
              sudo yum update -y

              # echo "Installing Docker..."
              sudo yum install docker -y
              sudo service docker start
              sudo systemctl enable docker

              # Install docker-compose
              sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              
              # Create a docker-compose.yml file
              # echo "Creating docker-compose.yml..."
              sudo wget https://github.com/milvus-io/milvus/releases/download/v2.0.2/milvus-standalone-docker-compose.yml -O docker-compose.yml
              
              # echo "Running docker compose"
              sudo docker-compose up -d
              # echo "User Data Script Completed"  
  MilvusSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Milvus EC2 instance
      # VpcId: !Ref VPCId  # Make sure you have a VPC ID or use the default
      # Allow inbound traffic on the required ports
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22                # Add this line for SSH
          ToPort: 22                  # Add this line for SSH
          CidrIp: 0.0.0.0/0  
        - IpProtocol: tcp
          FromPort: 19530
          ToPort: 19530
          CidrIp: 0.0.0.0/0   # Replace with appropriate CIDR for better security
        - IpProtocol: tcp
          FromPort: 19121
          ToPort: 19121
          CidrIp: 0.0.0.0/0   # Replace with appropriate CIDR for better security

Outputs:
  InstancePublicIP:
    Description: Public IP of the EC2 instance
    Value: !GetAtt MilvusInstance.PublicIp
  InstanceId:
    Description: Instance ID of the EC2 instance
    Value: !Ref MilvusInstance
